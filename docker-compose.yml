# ==============================================
# Voygo Modular Monolith - Docker Compose
# ==============================================
# This configuration runs:
# 1. MongoDB database
# 2. Voygo backend (modular monolith)
# 3. (Optional) Frontend can be added
# ==============================================

services:
  # ======================
  # MongoDB Database
  # ======================
  mongodb:
    image: mongo:7
    container_name: voygo-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USERNAME:-voygo}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-voygo123}
      MONGO_INITDB_DATABASE: voygo
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - voygo-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ======================
  # Voygo Backend (Modular Monolith)
  # ======================
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: voygo-backend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      # Server Configuration
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3000
      
      # MongoDB Connection
      # In the monolith, we connect directly to MongoDB
      MONGODB_URI: mongodb://${MONGO_USERNAME:-voygo}:${MONGO_PASSWORD:-voygo123}@mongodb:27017/voygo?authSource=admin
      
      # JWT Secret for authentication
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      
      # Google Maps API Key
      GOOGLE_MAPS_API: ${GOOGLE_MAPS_API:-your-google-maps-api-key}
      
      # Frontend URL for CORS
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:5173}
      
      # ==============================================
      # CRITICAL: Service-to-Service Communication
      # ==============================================
      # In the modular monolith, all services run on the same server.
      # These URLs point to localhost:3000 (the monolith itself).
      # This allows axios calls in controllers to loop back to the same server.
      # 
      # Example: When ride.controller calls USER_SERVICE_URL/users/:id
      # it actually calls http://localhost:3000/users/:id (same server)
      # ==============================================
      USER_SERVICE_URL: http://localhost:3000
      CAPTAIN_SERVICE_URL: http://localhost:3000
      RIDES_SERVICE_URL: http://localhost:3000
      GATEWAY_URL: http://localhost:3000
      
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - voygo-network
    # For development, mount source code for hot reload
    # Uncomment the volumes section below for development
    # volumes:
    #   - ./server.js:/app/server.js
    #   - ./socket.js:/app/socket.js
    #   - ./services:/app/services

# ======================
# Named Volumes
# ======================
volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local

# ======================
# Networks
# ======================
networks:
  voygo-network:
    driver: bridge
